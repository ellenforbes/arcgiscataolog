<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GIS Data Catalogue ‚Äî Pembroke</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --red:    #D7282F;
    --navy:   #1F1F55;
    --grey:   #86828B;
    --silver: #C9C4C4;
    --purple: #6D3A85;
    --slate:  #B8CED9;
    --navy-dark: #141430;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Calibri','Candara','Segoe UI',sans-serif; background: var(--navy-dark); color: #F4F2F2; min-height: 100vh; }

  /* HEADER */
  header { background: linear-gradient(135deg, var(--navy) 0%, var(--navy-dark) 60%, #0d0d25 100%); border-bottom: 3px solid var(--red); padding: 28px 40px 24px; position: relative; overflow: hidden; }
  header::before { content:''; position:absolute; top:-40px; right:-40px; width:220px; height:220px; background:radial-gradient(circle,rgba(215,40,47,.15) 0%,transparent 70%); pointer-events:none; }
  header::after  { content:''; position:absolute; bottom:-30px; left:200px; width:160px; height:160px; background:radial-gradient(circle,rgba(109,58,133,.15) 0%,transparent 70%); pointer-events:none; }
  .header-top { display:flex; align-items:flex-start; justify-content:space-between; gap:20px; flex-wrap:wrap; }
  .header-title-block h1 { font-family:'Oswald',sans-serif; font-size:2.6rem; font-weight:700; color:#fff; line-height:1; }
  .header-title-block h1 span { color:var(--red); }
  .header-title-block p { margin-top:6px; color:var(--slate); font-size:.82rem; letter-spacing:.08em; text-transform:uppercase; }
  .header-actions { display:flex; flex-direction:column; align-items:flex-end; gap:8px; flex-shrink:0; }
  .btn-info { display:inline-flex; align-items:center; gap:8px; background:transparent; border:1.5px solid rgba(184,206,217,.4); border-radius:6px; color:var(--slate); cursor:pointer; font-family:'Calibri',sans-serif; font-size:.88rem; font-weight:700; padding:10px 18px; transition:all .2s; white-space:nowrap; }
  .btn-info:hover { background:rgba(184,206,217,.12); border-color:var(--slate); color:#fff; transform:translateY(-1px); }
  .btn-info.active { background:rgba(184,206,217,.15); border-color:var(--slate); color:#fff; }

  /* INFO MODAL CONTENT */
  .info-items { display:flex; flex-direction:column; gap:16px; margin-top:4px; }
  .info-item { display:flex; align-items:flex-start; gap:12px; }
  .info-item-icon { display:flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:6px; border:1px solid; flex-shrink:0; margin-top:1px; }
  .info-item-label { font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--grey); margin-bottom:3px; }
  .info-item-text { font-size:.85rem; color:var(--silver); line-height:1.6; }
  .info-item-text strong { color:#fff; font-weight:700; }
  .info-link { color:var(--slate); text-decoration:underline; transition:color .15s; }
  .info-link:hover { color:#fff; }

  .btn-sitemap { display:inline-flex; align-items:center; gap:8px; background:transparent; border:1.5px solid var(--slate); border-radius:6px; color:var(--slate); cursor:pointer; font-family:'Calibri',sans-serif; font-size:.88rem; font-weight:700; padding:10px 18px; transition:all .2s; white-space:nowrap; text-decoration:none; }
  .btn-sitemap:hover { background:var(--slate); color:var(--navy-dark); transform:translateY(-1px); }
  .btn-spreadsheet { border-color:rgba(76,175,119,.5); color:#7dcca0; }
  .btn-spreadsheet:hover { background:#4caf77; border-color:#4caf77; color:#fff; }
  .btn-reload { display:inline-flex; align-items:center; gap:8px; background:var(--red); border:none; border-radius:6px; color:#fff; cursor:pointer; font-family:'Calibri',sans-serif; font-size:.88rem; font-weight:700; padding:10px 18px; transition:background .2s,transform .1s; white-space:nowrap; }
  .btn-reload:hover { background:#b81f25; transform:translateY(-1px); }
  .btn-reload:disabled { opacity:.5; cursor:not-allowed; transform:none; }
  .load-status { font-size:.75rem; color:var(--slate); text-align:right; }
  .load-status.ok  { color:#7dcca0; }
  .load-status.err { color:#f08080; }

  /* LOADING BAR */
  .loading-bar { height:3px; background:linear-gradient(90deg,var(--red),var(--purple),var(--red)); background-size:200%; animation:loadSlide 1.2s linear infinite; display:none; }
  .loading-bar.active { display:block; }
  @keyframes loadSlide { from{background-position:0%} to{background-position:200%} }

  /* STATS */
  .stats-row { display:flex; gap:14px; margin-top:24px; flex-wrap:wrap; }
  .stat-card { background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); border-radius:8px; padding:14px 20px; min-width:130px; position:relative; overflow:hidden; transition:border-color .2s; }
  .stat-card:hover { border-color:var(--red); }
  .stat-num { font-family:'Oswald',sans-serif; font-size:2.4rem; font-weight:700; color:#fff; line-height:1; }
  .stat-label { font-size:.72rem; text-transform:uppercase; letter-spacing:.1em; color:var(--slate); margin-top:3px; }
  .stat-accent { position:absolute; bottom:0; left:0; height:3px; width:100%; }
  .stat-card:nth-child(1) .stat-accent { background:var(--red); }
  .stat-card:nth-child(2) .stat-accent { background:var(--purple); }
  .stat-card:nth-child(3) .stat-accent { background:var(--slate); }
  .stat-card:nth-child(4) .stat-accent { background:#4caf77; }
  .stat-card:nth-child(5) .stat-accent { background:#f0a500; }
  .stat-card:nth-child(6) .stat-accent { background:#B8CED9; }

  /* MAIN */
  .main { display:grid; grid-template-columns:1fr 310px; padding:28px 40px; max-width:1600px; margin:0 auto; }

  /* CHART */
  .chart-panel { background:rgba(31,31,85,.4); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:22px 24px; margin-left:24px; align-self:start; position:sticky; top:20px; }
  .chart-panel h3 { font-family:'Oswald',sans-serif; font-size:1rem; font-weight:600; letter-spacing:.1em; text-transform:uppercase; color:var(--slate); margin-bottom:16px; }
  .bar-item { margin-bottom:12px; }
  .bar-label { display:flex; justify-content:space-between; font-size:.76rem; color:var(--silver); margin-bottom:5px; }
  .bar-count { color:#fff; font-weight:700; }
  .bar-track { background:rgba(255,255,255,.07); border-radius:3px; height:8px; overflow:hidden; }
  .bar-fill  { height:100%; border-radius:3px; transition:width .6s cubic-bezier(.4,0,.2,1); }

  /* SEARCH */
  .search-block { background:rgba(31,31,85,.4); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:20px 24px; margin-bottom:20px; }
  .search-block h3 { font-family:'Oswald',sans-serif; font-size:.85rem; font-weight:600; letter-spacing:.12em; text-transform:uppercase; color:var(--grey); margin-bottom:14px; }
  .search-row   { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:12px; }
  .search-row-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .field-group  { display:flex; flex-direction:column; gap:5px; }
  .field-group label { font-size:.7rem; text-transform:uppercase; letter-spacing:.1em; color:var(--grey); font-weight:700; }
  input[type="text"], select { background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12); border-radius:5px; color:#fff; font-family:'Calibri','Candara','Segoe UI',sans-serif; font-size:.88rem; padding:9px 12px; outline:none; transition:border-color .2s,box-shadow .2s; width:100%; }
  input:focus, select:focus { border-color:var(--red); box-shadow:0 0 0 3px rgba(215,40,47,.15); }
  select option { background:var(--navy-dark); }
  .filter-actions { display:flex; gap:10px; margin-top:14px; align-items:center; }
  .btn-clear { background:transparent; border:1px solid rgba(255,255,255,.15); border-radius:5px; color:var(--grey); cursor:pointer; font-family:'Calibri',sans-serif; font-size:.78rem; padding:7px 14px; transition:all .2s; letter-spacing:.05em; text-transform:uppercase; }
  .btn-clear:hover { border-color:var(--red); color:var(--red); }
  .result-count { margin-left:auto; font-size:.78rem; color:var(--grey); }
  .result-count strong { color:#fff; }

  /* TABLE */
  .table-wrap { background:rgba(31,31,85,.4); border:1px solid rgba(255,255,255,.08); border-radius:10px; overflow:hidden; }
  table { width:100%; border-collapse:collapse; }
  thead tr { background:rgba(215,40,47,.12); border-bottom:2px solid var(--red); }
  th { font-family:'Oswald',sans-serif; font-size:.82rem; font-weight:600; letter-spacing:.1em; text-transform:uppercase; color:var(--slate); padding:13px 16px; text-align:left; cursor:pointer; user-select:none; white-space:nowrap; }
  th:hover { color:#fff; }
  th .si { margin-left:4px; opacity:.4; font-size:.7rem; }
  th.sorted .si { opacity:1; color:var(--red); }
  tbody tr { border-bottom:1px solid rgba(255,255,255,.05); transition:background .15s; animation:fadeIn .22s ease both; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }
  tbody tr:hover { background:rgba(109,58,133,.12); }
  tbody tr:last-child { border-bottom:none; }
  td { padding:12px 16px; font-size:.86rem; vertical-align:middle; line-height:1.45; }
  td.name-cell { font-weight:700; color:#fff; max-width:180px; }
  td.name-cell a { color:inherit; text-decoration:none; }
  td.name-cell a:hover { color:var(--slate); text-decoration:underline; }
  td.summary-cell { max-width:230px; }
  .sum-text { color:var(--silver); font-size:.83rem; cursor:pointer; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; line-height:1.5; transition:color .15s; }
  .sum-text:hover { color:#fff; }
  .sum-text.expanded { display:block; -webkit-line-clamp:unset; }
  .sum-toggle { display:inline-block; color:var(--slate); font-size:.7rem; cursor:pointer; margin-top:3px; text-decoration:underline; user-select:none; }
  .sum-toggle:hover { color:var(--red); }
  td.cat-cell span { display:inline-block; padding:3px 10px; border-radius:20px; font-size:.7rem; font-weight:700; letter-spacing:.06em; text-transform:uppercase; white-space:nowrap; }
  td.remit-cell, td.owner-cell { color:var(--silver); font-size:.83rem; max-width:120px; }
  td.flags-cell { max-width:150px; }
  .flag-tag { display:inline-block; background:rgba(215,40,47,.18); border:1px solid rgba(215,40,47,.35); color:#f08080; padding:2px 8px; border-radius:3px; font-size:.66rem; margin:2px 2px 2px 0; font-weight:700; }
  td.actions-cell { white-space:nowrap; }
  .btn-link { display:inline-flex; align-items:center; gap:5px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:4px; color:var(--slate); cursor:pointer; font-family:'Calibri',sans-serif; font-size:.72rem; font-weight:700; padding:5px 10px; text-decoration:none; transition:all .18s; margin-bottom:4px; letter-spacing:.04em; }
  .btn-link:hover          { background:var(--red);    border-color:var(--red);    color:#fff; }
  .btn-link.arcgis:hover   { background:#2d85b4;       border-color:#2d85b4;       color:#fff; }
  .btn-link.shape:hover    { background:var(--purple);  border-color:var(--purple); color:#fff; }
  .btn-link.desc-btn       { background:rgba(109,58,133,.2); border-color:rgba(109,58,133,.4); color:#b89ecf; }
  .btn-link.desc-btn:hover { background:var(--purple);  border-color:var(--purple); color:#fff; }
  .btn-link svg { width:11px; height:11px; flex-shrink:0; }
  .no-results { text-align:center; padding:60px 20px; color:var(--grey); }
  .no-results strong { display:block; font-size:1.3rem; color:var(--silver); margin-bottom:6px; }

  /* MODAL */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.75); backdrop-filter:blur(4px); z-index:1000; display:flex; align-items:center; justify-content:center; padding:20px; opacity:0; pointer-events:none; transition:opacity .2s; }
  .modal-overlay.open { opacity:1; pointer-events:all; }
  .modal { background:#1a1a45; border:1px solid rgba(255,255,255,.12); border-top:3px solid var(--purple); border-radius:12px; max-width:640px; width:100%; padding:28px 32px; position:relative; transform:translateY(20px); transition:transform .25s cubic-bezier(.34,1.56,.64,1); max-height:82vh; overflow-y:auto; }
  .modal-overlay.open .modal { transform:translateY(0); }
  .modal-close { position:absolute; top:14px; right:16px; background:transparent; border:none; color:var(--grey); cursor:pointer; font-size:1.5rem; line-height:1; transition:color .15s; }
  .modal-close:hover { color:var(--red); }
  .modal-cat { display:inline-block; padding:3px 12px; border-radius:20px; font-size:.7rem; font-weight:700; letter-spacing:.08em; text-transform:uppercase; margin-bottom:10px; }
  .modal h2 { font-family:'Oswald',sans-serif; font-size:1.65rem; font-weight:700; color:#fff; margin-bottom:4px; line-height:1.2; }
  .modal-section { margin-top:18px; }
  .modal-section-label { font-size:.68rem; font-weight:700; text-transform:uppercase; letter-spacing:.12em; color:var(--grey); margin-bottom:6px; }
  .modal-section p { color:var(--silver); font-size:.9rem; line-height:1.75; }
  .modal-section p.empty { color:var(--grey); font-style:italic; }
  .modal-meta { display:grid; grid-template-columns:1fr 1fr; gap:12px 24px; margin-top:18px; padding-top:16px; border-top:1px solid rgba(255,255,255,.08); }
  .meta-label { font-size:.66rem; text-transform:uppercase; letter-spacing:.1em; color:var(--grey); margin-bottom:3px; }
  .meta-value { color:var(--silver); font-size:.86rem; }
  .modal-links { display:flex; gap:8px; flex-wrap:wrap; margin-top:18px; padding-top:16px; border-top:1px solid rgba(255,255,255,.08); }
  .modal-links .btn-link { font-size:.82rem; padding:7px 14px; }

  @media(max-width:1100px) { .main{grid-template-columns:1fr} .chart-panel{margin-left:0;margin-top:20px;order:-1;position:static} .search-row{grid-template-columns:1fr 1fr} }
  @media(max-width:700px)  { header{padding:20px} .main{padding:16px} .search-row{grid-template-columns:1fr} .header-title-block h1{font-size:1.8rem} }
  .auth-tick { display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; background:#2e7d52; border:1.5px solid #4caf77; border-radius:50%; color:#7dcca0; font-size:.6rem; font-weight:900; margin-left:6px; vertical-align:middle; flex-shrink:0; cursor:default; }
  .auth-tick-lg { width:22px; height:22px; font-size:.8rem; }

  ::-webkit-scrollbar{width:6px;height:6px} ::-webkit-scrollbar-track{background:transparent} ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:3px}
</style>
</head>
<body>

<header>
  <div class="header-top">
    <div class="header-title-block">
      <h1>GIS Data <span>Catalogue</span></h1>
      <p>Pembroke Olive Downs ‚Äî Spatial Data Registry</p>
    </div>
    <div class="header-actions">
      <div style="display:flex;gap:10px;align-items:center;">
        <a class="btn-sitemap" href="https://pembrokeod.maps.arcgis.com/apps/mapviewer/index.html?webmap=cae3263e09d04d5b847bf01876c3aeff" target="_blank">
          <svg viewBox="0 0 24 24" fill="currentColor" width="15" height="15"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
          Pembroke Site Map
        </a>
        <a class="btn-sitemap btn-spreadsheet" href="https://pembrokeresources.sharepoint.com/:x:/s/PembrokeIntranet/PI/IQB-Bbhsh0Z3T4pb8n9S1KflAXoHlGx6NfdM1AH7jxPTBBs?e=HeeNbf" target="_blank">
          <svg viewBox="0 0 24 24" fill="currentColor" width="15" height="15"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3h5v2h-5V6zm0 4h5v2h-5v-2zm0 4h5v2h-5v-2zM7 6h3v2H7V6zm0 4h3v2H7v-2zm0 4h3v2H7v-2z"/></svg>
          View as Spreadsheet
        </a>
        <button class="btn-info" onclick="toggleInfoPanel()">
          <svg viewBox="0 0 24 24" fill="currentColor" width="15" height="15"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
          Data Info
        </button>
        <button class="btn-info" onclick="openLayersModal()">
          <svg viewBox="0 0 24 24" fill="currentColor" width="15" height="15"><path d="M11.99 2L2 7l10 5 10-5-10.01-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
          Maps vs Layers
        </button>
        <button class="btn-reload" id="btnReload" onclick="loadData()">
          <svg viewBox="0 0 24 24" fill="currentColor" width="15" height="15"><path d="M17.65 6.35A7.96 7.96 0 0012 4C7.58 4 4 7.58 4 12s3.58 8 8 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          Reload Data
        </button>
      </div>
      <div class="load-status" id="loadStatus">Loading‚Ä¶</div>
    </div>
  </div>
  <div class="stats-row" id="statsRow"></div>
</header>

<div class="loading-bar" id="loadingBar"></div>

<div class="main">
  <div class="left-col">
    <div class="search-block">
      <h3>Search &amp; Filter</h3>
      <div class="search-row" style="grid-template-columns:1fr 1fr">
        <div class="field-group">
          <label>Free Text</label>
          <input type="text" id="searchText" placeholder="Name, summary, tags‚Ä¶" oninput="applyFilters()">
        </div>
        <div class="field-group">
          <label>Category</label>
          <select id="filterCategory" onchange="applyFilters()"><option value="">All Categories</option></select>
        </div>
      </div>
      <div class="search-row">
        <div class="field-group">
          <label>SLT Remit</label>
          <select id="filterRemit" onchange="applyFilters()"><option value="">All Remits</option></select>
        </div>
        <div class="field-group">
          <label>Owner</label>
          <select id="filterOwner" onchange="applyFilters()"><option value="">All Owners</option></select>
        </div>
        <div class="field-group">
          <label>Flags</label>
          <select id="filterFlag" onchange="applyFilters()">
            <option value="">All Items</option>
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn-clear" onclick="clearFilters()">‚úï Clear Filters</button>
        <span class="result-count" id="resultCount"></span>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th onclick="sortBy('item_name')">Item Name <span class="si" id="sort_item_name">‚Üï</span></th>
            <th onclick="sortBy('category')">Category <span class="si" id="sort_category">‚Üï</span></th>
            <th>Summary</th>
            <th onclick="sortBy('remit')">Remit <span class="si" id="sort_remit">‚Üï</span></th>
            <th onclick="sortBy('owner')">Owner <span class="si" id="sort_owner">‚Üï</span></th>
            <th>Flags</th>
            <th>Links</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div class="no-results" id="noResults" style="display:none">
        <strong>No results found</strong>
        Try adjusting your search or clearing filters
      </div>
    </div>
  </div>

  <div class="chart-panel">
    <h3 id="chartHeading">Items by Category</h3>
    <div id="chartBars"></div>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="bgClose(event)">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div id="modalContent"></div>
  </div>
</div>

<!-- Info Modal -->
<div class="modal-overlay" id="infoModalOverlay" onclick="bgCloseInfo(event)">
  <div class="modal" style="border-top-color:var(--slate);max-width:560px;">
    <button class="modal-close" onclick="closeInfoModal()">‚úï</button>
    <h2 style="font-family:'Oswald',sans-serif;font-size:1.3rem;color:#fff;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
      <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20" style="color:var(--slate);flex-shrink:0"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
      Download &amp; Format Information
    </h2>
    <div class="info-items">
      <div class="info-item">
        <div class="info-item-icon" style="background:rgba(45,133,180,.2);border-color:rgba(45,133,180,.4);">
          <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14" style="color:#7db8d4"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>
        </div>
        <div>
          <div class="info-item-label">DXF Files</div>
          <div class="info-item-text">All DXF files available for download are in <strong>GDA94 MGA Zone 55</strong>.</div>
        </div>
      </div>
      <div class="info-item">
        <div class="info-item-icon" style="background:rgba(109,58,133,.2);border-color:rgba(109,58,133,.4);">
          <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14" style="color:#b89ecf"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
        </div>
        <div>
          <div class="info-item-label">Shapefiles</div>
          <div class="info-item-text">All shapefiles are in <strong>WGS84</strong>.</div>
        </div>
      </div>
      <div class="info-item">
        <div class="info-item-icon" style="background:rgba(76,175,119,.18);border-color:rgba(76,175,119,.4);">
          <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14" style="color:#7dcca0"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
        </div>
        <div>
          <div class="info-item-label">Need a KML?</div>
          <div class="info-item-text">Download the shapefile, zip all its parts together, then use the free online converter to convert the zip to KML: <a href="https://mygeodata.cloud/converter/shp-to-kml" target="_blank" class="info-link">mygeodata.cloud/converter/shp-to-kml ‚Üí</a></div>
        </div>
      </div>
      <div class="info-item">
        <div class="info-item-icon" style="background:rgba(240,165,0,.18);border-color:rgba(240,165,0,.4);">
          <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14" style="color:#f0c96a"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
        </div>
        <div>
          <div class="info-item-label">Imagery</div>
          <div class="info-item-text">Imagery is <strong>not available for download</strong>. Thiess monthly images will be linked in the layer description. Contact <strong>Ellen</strong> if you need a full image ECW sent to you.</div>
        </div>
      </div>
      <div class="info-item">
        <div class="info-item-icon" style="background:rgba(215,40,47,.15);border-color:rgba(215,40,47,.4);">
          <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14" style="color:#e08084"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 4l5 2.18V11c0 3.5-2.33 6.79-5 7.93-2.67-1.14-5-4.43-5-7.93V7.18L12 5z"/></svg>
        </div>
        <div>
          <div class="info-item-label">Government Datasets</div>
          <div class="info-item-text">Government datasets (or subsets thereof) are <strong>not available for local download</strong>. A link to the original government data source can be found in the <strong>More Details</strong> description of the relevant layer and the data can be downloaded in it's original form from there.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Maps vs Layers Modal -->
<div class="modal-overlay" id="layersModalOverlay" onclick="bgCloseLayers(event)">
  <div class="modal" style="border-top-color:#4caf77;max-width:620px;">
    <button class="modal-close" onclick="closeLayersModal()">‚úï</button>
    <h2 style="font-family:'Oswald',sans-serif;font-size:1.3rem;color:#fff;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
      <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20" style="color:#7dcca0;flex-shrink:0"><path d="M11.99 2L2 7l10 5 10-5-10.01-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      Maps vs. Layers Explainer
    </h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
      <div style="background:rgba(76,175,119,.1);border:1px solid rgba(76,175,119,.3);border-radius:8px;padding:16px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
          <div style="background:rgba(76,175,119,.2);border:1px solid rgba(76,175,119,.5);border-radius:6px;width:30px;height:30px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
            <svg viewBox="0 0 24 24" fill="currentColor" width="15" height="15" style="color:#7dcca0"><path d="M11.99 2L2 7l10 5 10-5-10.01-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
          </div>
          <div style="font-family:'Oswald',sans-serif;font-size:.9rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:#7dcca0;">What is a Layer?</div>
        </div>
        <p style="color:var(--silver);font-size:.85rem;line-height:1.65;">A layer is <strong style="color:#fff;">one piece of spatial information</strong> ‚Äî a table (like you'd see in Excel) with extra columns containing spatial coordinates. Those coordinates are read by the map to display the table as a visible spatial layer.</p>
      </div>
      <div style="background:rgba(45,133,180,.1);border:1px solid rgba(45,133,180,.3);border-radius:8px;padding:16px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
          <div style="background:rgba(45,133,180,.25);border:1px solid rgba(45,133,180,.5);border-radius:6px;width:30px;height:30px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
            <svg viewBox="0 0 24 24" fill="currentColor" width="15" height="15" style="color:#7db8d4"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
          </div>
          <div style="font-family:'Oswald',sans-serif;font-size:.9rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:#7db8d4;">What is a Map?</div>
        </div>
        <p style="color:var(--silver);font-size:.85rem;line-height:1.65;">One map can contain <strong style="color:#fff;">lots of layers</strong> and is a way to view and interact with lots of spatial data ‚Äî like the <strong style="color:#fff;">Pembroke Site Map</strong>.</p>
      </div>
    </div>
    <div style="border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,.1);">
      <img src="https://pembrokeod.maps.arcgis.com/sharing/rest/content/items/b4a2d096ca994079869c01aa5327fbfa/data"
           alt="Maps vs Layers diagram"
           style="width:100%;display:block;">
    </div>
  </div>
</div>

<script>
const FEATURE_LAYER_URL = 'https://services7.arcgis.com/GXOKTXcYr7P745Z7/arcgis/rest/services/agol_catalog/FeatureServer/0';

// Dynamic category colour palette ‚Äî rich set that fits the dark navy theme
const CAT_PALETTE = [
  {bg:'rgba(76,175,119,.18)',  color:'#7dcca0', bar:'#4caf77'},   // green
  {bg:'rgba(45,133,180,.2)',   color:'#7db8d4', bar:'#2d85b4'},   // blue
  {bg:'rgba(109,58,133,.2)',   color:'#b89ecf', bar:'#6D3A85'},   // purple
  {bg:'rgba(215,40,47,.15)',   color:'#e08084', bar:'#D7282F'},   // red
  {bg:'rgba(240,165,0,.18)',   color:'#f0c96a', bar:'#c98a00'},   // amber
  {bg:'rgba(0,188,212,.15)',   color:'#80deea', bar:'#00acc1'},   // cyan
  {bg:'rgba(255,112,67,.18)',  color:'#ffab91', bar:'#e64a19'},   // deep orange
  {bg:'rgba(102,187,106,.18)', color:'#a5d6a7', bar:'#388e3c'},   // teal-green
  {bg:'rgba(171,71,188,.18)',  color:'#ce93d8', bar:'#8e24aa'},   // deep purple
  {bg:'rgba(38,166,154,.18)',  color:'#80cbc4', bar:'#00897b'},   // teal
  {bg:'rgba(236,64,122,.18)',  color:'#f48fb1', bar:'#c2185b'},   // pink
  {bg:'rgba(255,179,0,.18)',   color:'#ffe082', bar:'#ff8f00'},   // yellow-amber
  {bg:'rgba(41,182,246,.18)',  color:'#81d4fa', bar:'#0288d1'},   // light blue
  {bg:'rgba(156,204,101,.18)', color:'#c5e1a5', bar:'#7cb342'},   // light green
  {bg:'rgba(255,138,101,.18)', color:'#ffccbc', bar:'#f4511e'},   // orange
  {bg:'rgba(120,144,156,.2)',  color:'#b0bec5', bar:'#546e7a'},   // blue-grey
];

let CAT_COLOR_MAP = {};
const catStyle = c => CAT_COLOR_MAP[c] || {bg:'rgba(134,130,139,.15)', color:'#C9C4C4', bar:'#86828B'};

function buildCatColorMap() {
  const cats = [...new Set(DATA.map(d => d.category).filter(Boolean))].sort();
  CAT_COLOR_MAP = {};
  cats.forEach((cat, i) => { CAT_COLOR_MAP[cat] = CAT_PALETTE[i % CAT_PALETTE.length]; });
}

let DATA = [], currentFiltered = [], sortField = null, sortAsc = true;

async function loadData() {
  setLoading(true);
  setStatus('Loading‚Ä¶', '');
  try {
    const params = new URLSearchParams({ where:'1=1', outFields:'*', returnGeometry:'false', resultRecordCount:2000, f:'json' });
    const resp = await fetch(`${FEATURE_LAYER_URL}/query?${params}`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const json = await resp.json();
    if (json.error) throw new Error(json.error.message);

    DATA = json.features.map(f => {
      const a = f.attributes;
      return {
        item_name:   sv(a.item_name),
        category:    sv(a.category),
        snippet:     sv(a.snippet),
        remit:       sv(a.remit),
        owner:       sv(a.owner),
        description: sv(a.description),
        tags:        sv(a.tags),
        url_to_data: sv(a.url_to_data),
        back_up:        sv(a.back_up),
        authoritative:  sv(a.authoritative),
        dxf_path:       sv(a.dxf_path),
        shape_path:     sv(a.shape_path),
        flags:          sv(a.flags),
      };
    });

    populateDropdowns();
    buildCatColorMap();
    renderStats();
    applyFilters();
    setStatus(`‚úì ${DATA.length} items loaded`, 'ok');
  } catch(e) {
    setStatus('‚ö† ' + e.message, 'err');
    console.error(e);
  }
  setLoading(false);
}

const sv = v => (v === null || v === undefined) ? '' : String(v).trim();
const setLoading = on => { document.getElementById('loadingBar').classList.toggle('active', on); document.getElementById('btnReload').disabled = on; };
const setStatus  = (msg, cls='') => { const el=document.getElementById('loadStatus'); el.textContent=msg; el.className='load-status '+cls; };

function populateDropdowns() {
  [['filterCategory','category','Categories'],['filterRemit','remit','Remits'],['filterOwner','owner','Owners']].forEach(([id,field,label]) => {
    const sel=document.getElementById(id), cur=sel.value;
    sel.innerHTML=`<option value="">All ${label}</option>`;
    [...new Set(DATA.map(d=>d[field]).filter(Boolean))].sort().forEach(v=>sel.add(new Option(v,v)));
    sel.value=cur;
  });

  // Flags: parse all comma-delimited values across all records
  const flagSel=document.getElementById('filterFlag'), curFlag=flagSel.value;
  const allFlags=[...new Set(
    DATA.flatMap(d=>d.flags ? d.flags.split(',').map(f=>f.trim()).filter(Boolean) : [])
  )].sort();
  flagSel.innerHTML='<option value="">All Items</option>';
  allFlags.forEach(f=>flagSel.add(new Option(f,f)));
  flagSel.value=curFlag;
}

function renderStats(subset) {
  const src = subset || DATA;
  const cats=new Set(src.map(d=>d.category).filter(Boolean));
  const owners=new Set(src.map(d=>d.owner).filter(Boolean));
  const eligible=src.filter(d=>d.back_up!=='Skipped - Government Tag' && d.back_up!=='No Back Up Attempted');
  const backedUp=eligible.filter(d=>d.back_up==='Backed Up to GDB').length;
  const backupPct=eligible.length?Math.round(backedUp/eligible.length*100):0;
  const flagged=src.filter(d=>d.flags).length;
  const authoritative=src.filter(d=>d.authoritative && d.authoritative.toLowerCase()==='yes').length;
  const verifiedPct=src.length?Math.round(authoritative/src.length*100):0;
  document.getElementById('statsRow').innerHTML=[
    {num:src.length,      label:'Total Datasets'},
    {num:cats.size,       label:'Categories'},
    {num:owners.size,     label:'Owners'},
    {num:backupPct+'%',   label:'Backed Up'},
    {num:flagged,         label:'Items Flagged'},
    {num:verifiedPct+'%', label:'Verified Data'},
  ].map(s=>`<div class="stat-card"><div class="stat-num">${s.num}</div><div class="stat-label">${s.label}</div><div class="stat-accent"></div></div>`).join('');
}

function renderChart(filtered) {
  const cat = document.getElementById('filterCategory').value;
  const byRemit = !!cat;
  document.getElementById('chartHeading').textContent = byRemit ? `${cat} ‚Äî by SLT Remit` : 'Items by Category';

  const counts = {};
  filtered.forEach(d => {
    const key = byRemit ? (d.remit || '(No Remit)') : d.category;
    if (key) counts[key] = (counts[key] || 0) + 1;
  });
  const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]), max = sorted[0]?.[1] || 1;

  document.getElementById('chartBars').innerHTML = sorted.map(([label, n]) => {
    const st = byRemit
      ? {bar: '#B8CED9'}   // neutral slate for remit view; no category colour needed
      : catStyle(label);
    // Give each remit bar a distinct colour from the palette by index
    const remitColours = ['#4caf77','#2d85b4','#b89ecf','#f0c96a','#80deea','#ffab91','#ce93d8','#80cbc4','#f48fb1','#c5e1a5'];
    const barCol = byRemit ? remitColours[sorted.findIndex(([l])=>l===label) % remitColours.length] : st.bar;
    return `<div class="bar-item"><div class="bar-label"><span>${h(label)}</span><span class="bar-count">${n}</span></div><div class="bar-track"><div class="bar-fill" style="width:${Math.round(n/max*100)}%;background:${barCol}"></div></div></div>`;
  }).join('');
}

function sortBy(field) {
  sortAsc=sortField===field?!sortAsc:true; sortField=field;
  document.querySelectorAll('th .si').forEach(el=>{el.textContent='‚Üï';el.parentElement.classList.remove('sorted');});
  const icon=document.getElementById('sort_'+field);
  if(icon){icon.textContent=sortAsc?'‚Üë':'‚Üì';icon.parentElement.classList.add('sorted');}
  applyFilters();
}

function applyFilters() {
  const text=document.getElementById('searchText').value.trim().toLowerCase();
  const cat=document.getElementById('filterCategory').value;
  const remit=document.getElementById('filterRemit').value;
  const owner=document.getElementById('filterOwner').value;
  const flagF=document.getElementById('filterFlag').value;

  // Subset filtered only by category ‚Äî used to repopulate dependent dropdowns
  const catSubset = cat ? DATA.filter(d => d.category === cat) : DATA;
  updateDependentDropdowns(catSubset, remit, owner, flagF);

  let filtered=DATA.filter(d=>{
    if(cat   && d.category!==cat)  return false;
    if(remit && d.remit!==remit)   return false;
    if(owner && d.owner!==owner)   return false;
    if(flagF && !(d.flags && d.flags.split(',').map(f=>f.trim()).includes(flagF))) return false;
    if(text){const hay=[d.item_name,d.snippet,d.description,d.tags,d.flags,d.remit,d.owner].join(' ').toLowerCase();if(!hay.includes(text))return false;}
    return true;
  });

  if(sortField) filtered.sort((a,b)=>{
    const av=(a[sortField]||'').toLowerCase(),bv=(b[sortField]||'').toLowerCase();
    return sortAsc?av.localeCompare(bv):bv.localeCompare(av);
  });

  currentFiltered=filtered;
  renderTable(filtered); renderChart(filtered); renderStats(filtered);
  document.getElementById('resultCount').innerHTML=`<strong>${filtered.length}</strong> of ${DATA.length} items`;
}

function updateDependentDropdowns(subset, curRemit, curOwner, curFlag) {
  // Remit
  const remitSel = document.getElementById('filterRemit');
  const remits = [...new Set(subset.map(d=>d.remit).filter(Boolean))].sort();
  remitSel.innerHTML = '<option value="">All Remits</option>';
  remits.forEach(v => remitSel.add(new Option(v,v)));
  if (remits.includes(curRemit)) remitSel.value = curRemit;

  // Owner
  const ownerSel = document.getElementById('filterOwner');
  const owners = [...new Set(subset.map(d=>d.owner).filter(Boolean))].sort();
  ownerSel.innerHTML = '<option value="">All Owners</option>';
  owners.forEach(v => ownerSel.add(new Option(v,v)));
  if (owners.includes(curOwner)) ownerSel.value = curOwner;

  // Flags
  const flagSel = document.getElementById('filterFlag');
  const flags = [...new Set(subset.flatMap(d => d.flags ? d.flags.split(',').map(f=>f.trim()).filter(Boolean) : []))].sort();
  flagSel.innerHTML = '<option value="">All Items</option>';
  flags.forEach(f => flagSel.add(new Option(f,f)));
  if (flags.includes(curFlag)) flagSel.value = curFlag;
}

function clearFilters() {
  document.getElementById('searchText').value='';
  ['filterCategory','filterRemit','filterOwner','filterFlag'].forEach(id=>document.getElementById(id).value='');
  applyFilters();
}

function renderTable(data) {
  const body=document.getElementById('tableBody'), noRes=document.getElementById('noResults');
  if(!data.length){body.innerHTML='';noRes.style.display='block';return;}
  noRes.style.display='none';
  body.innerHTML=data.map((d,i)=>{
    const st=catStyle(d.category);
    const catBadge=d.category?`<span style="background:${st.bg};color:${st.color};border:1px solid ${st.color}44">${h(d.category)}</span>`:'‚Äî';
    const hasLong=d.snippet.length>100;
    const summaryCell=d.snippet
      ?`<div class="sum-text" id="sum-${i}" onclick="toggleSum(${i})">${h(d.snippet)}</div>${hasLong?`<span class="sum-toggle" id="sum-tog-${i}" onclick="toggleSum(${i})">Show more</span>`:''}`
      :`<em style="color:var(--grey);font-size:.8rem">‚Äî</em>`;
    const flagHtml=d.flags?d.flags.split(',').map(f=>`<span class="flag-tag">${h(f.trim())}</span>`).join(''):'<span style="color:var(--grey);font-size:.72rem">‚Äî</span>';
    const links=[];
    if(d.url_to_data) links.push(`<a class="btn-link arcgis" href="${d.url_to_data}" target="_blank"><svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 1a7 7 0 100 14A7 7 0 008 1zm-.5 3.5h1V8H11v1H7.5V4.5z"/></svg>ArcGIS</a>`);
    if(d.dxf_path)    links.push(`<a class="btn-link" href="${d.dxf_path}" target="_blank"><svg viewBox="0 0 16 16" fill="currentColor"><path d="M3 2h7l3 3.5V14H3V2zm7-.5V5.5h3"/></svg>DXF</a>`);
    if(d.shape_path)  links.push(`<a class="btn-link shape" href="${d.shape_path}" target="_blank"><svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 1L1 6l7 9 7-9z"/></svg>Shape</a>`);
    const detailBtn=`<button class="btn-link desc-btn" onclick="openModal(${i})"><svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 1a7 7 0 100 14A7 7 0 008 1zM7 5h2v2H7zm0 3h2v5H7z"/></svg>Details</button>`;
    return `<tr style="animation-delay:${i*0.025}s">
      <td class="name-cell"><a href="${d.url_to_data||'#'}" target="_blank">${h(d.item_name)}</a>${d.authoritative.toLowerCase()==='yes'?'<span class="auth-tick" title="Authoritative Dataset">‚úì</span>':''}</td>
      <td class="cat-cell">${catBadge}</td>
      <td class="summary-cell">${summaryCell}</td>
      <td class="remit-cell">${h(d.remit)||'<span style="color:var(--grey)">‚Äî</span>'}</td>
      <td class="owner-cell">${h(d.owner)||'<span style="color:var(--grey)">‚Äî</span>'}</td>
      <td class="flags-cell">${flagHtml}</td>
      <td class="actions-cell">${[...links,detailBtn].join('<br>')}</td>
    </tr>`;
  }).join('');
}

function toggleSum(i) {
  const el=document.getElementById('sum-'+i),tog=document.getElementById('sum-tog-'+i);
  if(!el)return; const exp=el.classList.toggle('expanded');
  if(tog)tog.textContent=exp?'Show less':'Show more';
}

function openModal(i) {
  const d=currentFiltered[i],st=catStyle(d.category);
  const linkBtns=[];
  if(d.url_to_data) linkBtns.push(`<a class="btn-link arcgis" href="${d.url_to_data}" target="_blank">üåê Open in ArcGIS</a>`);
  if(d.dxf_path)    linkBtns.push(`<a class="btn-link" href="${d.dxf_path}" target="_blank">üìÑ Download DXF</a>`);
  if(d.shape_path)  linkBtns.push(`<a class="btn-link shape" href="${d.shape_path}" target="_blank">üó∫ Download Shape</a>`);
  const flagHtml=d.flags?d.flags.split(',').map(f=>`<span class="flag-tag">${h(f.trim())}</span>`).join(' '):'<em style="color:var(--grey)">None</em>';
  document.getElementById('modalContent').innerHTML=`
    ${d.category?`<div class="modal-cat" style="background:${st.bg};color:${st.color};border:1px solid ${st.color}44">${h(d.category)}</div>`:''}
    <h2>${h(d.item_name)}${d.authoritative.toLowerCase()==='yes'?'<span class="auth-tick auth-tick-lg" title="Authoritative Dataset">‚úì</span>':''}</h2>
    ${d.snippet?`<div class="modal-section"><div class="modal-section-label">Summary</div><p>${h(d.snippet)}</p></div>`:''}
    <div class="modal-section"><div class="modal-section-label">Description</div><p ${d.description?'':'class="empty"'}>${d.description?h(d.description):'No description provided.'}</p></div>
    <div class="modal-meta">
      <div><div class="meta-label">Remit</div><div class="meta-value">${h(d.remit)||'‚Äî'}</div></div>
      <div><div class="meta-label">Owner</div><div class="meta-value">${h(d.owner)||'‚Äî'}</div></div>
      <div><div class="meta-label">Tags</div><div class="meta-value">${h(d.tags)||'‚Äî'}</div></div>
      <div><div class="meta-label">Back Up Status</div><div class="meta-value">${h(d.back_up)||'‚Äî'}</div></div>
      <div style="grid-column:1/-1"><div class="meta-label">Flags</div><div class="meta-value">${flagHtml}</div></div>
    </div>
    ${linkBtns.length?`<div class="modal-links">${linkBtns.join('')}</div>`:''}`;
  document.getElementById('modalOverlay').classList.add('open');
  document.body.style.overflow='hidden';
}

function bgClose(e){if(e.target===document.getElementById('modalOverlay'))closeModal();}
function closeModal(){document.getElementById('modalOverlay').classList.remove('open');document.body.style.overflow='';}
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeModal();closeInfoModal();closeLayersModal();}});
const h=str=>String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

function imgFallback(img) {
  img.parentElement.innerHTML = '<p style="padding:20px;text-align:center;color:var(--grey);font-size:.82rem;">‚ö† Image requires SharePoint login ‚Äî open the link directly to view it.</p>';
}

function openLayersModal() {
  document.getElementById('layersModalOverlay').classList.add('open');
  document.body.style.overflow='hidden';
}
function closeLayersModal() {
  document.getElementById('layersModalOverlay').classList.remove('open');
  document.body.style.overflow='';
}
function bgCloseLayers(e) { if(e.target===document.getElementById('layersModalOverlay')) closeLayersModal(); }

function toggleInfoPanel() {
  document.getElementById('infoModalOverlay').classList.add('open');
  document.body.style.overflow='hidden';
}
function closeInfoModal() {
  document.getElementById('infoModalOverlay').classList.remove('open');
  document.body.style.overflow='';
}
function bgCloseInfo(e) { if(e.target===document.getElementById('infoModalOverlay')) closeInfoModal(); }

loadData();
</script>
</body>
</html>